<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACONFEX · CAPA (Acciones Correctivas y Preventivas)</title>
  <meta name="description" content="Gestor CAPA simple para operaciones de exportación (GFA/ACONFEX). Guarda localmente, exporta a PDF y maneja evidencias con vista previa. Incluye matriz de riesgo (gravedad x probabilidad)." />
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --ink:#e9edf2; --muted:#9fb0c3; --brand:#3fb389;
      --accent:#2a8cff; --danger:#ff5d6c; --warn:#ffb020; --ok:#29c072; --purple:#a78bfa;
      --bd:1px solid rgba(255,255,255,.08);
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    .wrap{max-width:1100px;margin:auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;margin:6px 0 16px}
    header .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brand),#1b6c50 60%)}
    header h1{font-size:20px;margin:0}
    header .sub{color:var(--muted);font-size:12px}

    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:800px){.g2,.g3{grid-template-columns:1fr}}

    .card{background:var(--panel);border:var(--bd);border-radius:14px;padding:14px}
    .card h2{font-size:16px;margin:0 0 8px}
    .card h3{font-size:14px;margin:18px 0 8px;color:var(--muted)}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,select,textarea{width:100%;background:#0e141d;border:var(--bd);color:var(--ink);padding:10px;border-radius:8px;outline:none;appearance:none}
    textarea{min-height:88px;resize:vertical}

    .row{display:flex;gap:8px;align-items:center}
    .tag{font-size:11px;background:#0e141d;border:var(--bd);border-radius:999px;padding:4px 8px;color:var(--muted)}
    .help{border-bottom:1px dotted var(--muted);cursor:help}

    .actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    button{background:var(--accent);border:none;border-radius:12px;padding:10px 12px;color:white;cursor:pointer}
    .ghost{background:transparent;border:var(--bd);color:var(--ink)}
    .danger{background:var(--danger)}
    .ok{background:var(--ok)}
    .warn{background:var(--warn)}
    button:disabled{opacity:.55;cursor:not-allowed}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:var(--bd);text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:600}

    /* Evidencias */
    .uploader{border:2px dashed rgba(255,255,255,.12);border-radius:14px;padding:12px;text-align:center;background:#0e141d}
    .evidence-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:10px}
    .ev{border:var(--bd);border-radius:12px;overflow:hidden;background:#0b1119}
    .thumb{display:block;width:100%;height:120px;object-fit:cover;background:#0b0f14;cursor:pointer}
    .ev .meta{padding:8px}
    .ev .meta .name{font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ev .meta .size{font-size:11px;color:var(--muted)}

    .state{font-size:11px;padding:4px 8px;border-radius:999px;border:var(--bd);display:inline-block}
    .s-open{background:rgba(255,93,108,.12)}
    .s-run{background:rgba(42,140,255,.12)}
    .s-hold{background:rgba(255,176,32,.12)}
    .s-done{background:rgba(41,192,114,.12)}

    .risk{font-size:11px;padding:4px 8px;border-radius:999px;border:var(--bd);display:inline-block}
    .r-low{background:rgba(63,179,137,.15)}
    .r-med{background:rgba(255,176,32,.18)}
    .r-high{background:rgba(255,93,108,.18)}
    .r-crit{background:rgba(167,139,250,.18)}

    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:var(--bd);background:#0e141d;color:var(--muted);font-size:12px}
    .pill input{width:auto;background:transparent;border:none;padding:0;color:var(--ink)}

    .footer{color:var(--muted);font-size:12px;margin:18px 0 6px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#0e141d;border:var(--bd);border-radius:6px;padding:2px 6px}

    /* Modal vista previa */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
    .modal.open{display:flex}
    .modal-inner{background:#0b1119;border:var(--bd);border-radius:14px;max-width:90vw;max-height:85vh;overflow:auto;padding:10px}
    .modal-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:4px 6px 10px}
    .modal-title{font-size:14px;color:var(--muted)}
    .modal-close{background:transparent;border:var(--bd);color:var(--ink);border-radius:8px;padding:6px 8px;cursor:pointer}
    .modal-content img{max-width:100%;height:auto;display:block}
    .modal-content iframe{width:80vw;max-width:900px;height:70vh;border:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>ACONFEX · CAPA</h1>
        <div class="sub">Correctivas y Preventivas para operaciones de exportación · 100% local (no envía datos)</div>
      </div>
    </header>

    <div class="grid g2">
      <!-- Formulario principal -->
      <section class="card" id="formCard">
        <h2>Nuevo/Editar CAPA</h2>
        <div class="grid g3">
          <div>
            <label>ID (auto)</label>
            <input id="capaId" placeholder="CAPA-001" readonly>
          </div>
          <div>
            <label>Revisión <span class="help" title="Número de versión del mismo CAPA. El ID no cambia; la revisión aumenta para mantener historial.">¿Qué es?</span></label>
            <input id="capaRev" type="number" value="0" min="0">
          </div>
          <div>
            <label>Estado</label>
            <select id="capaEstado">
              <option>Abierta</option>
              <option>En contención</option>
              <option>En curso</option>
              <option>Cerrada</option>
            </select>
          </div>
        </div>

        <div class="grid g3">
          <div>
            <label>Fecha de detección <span class="help" title="Cuándo se detectó el problema por primera vez">¿Qué es?</span></label>
            <input id="fechaDeteccion" type="date" placeholder="dd/mm/aaaa">
          </div>
          <div>
            <label>Fecha de cierre comprometida <span class="help" title="Fecha objetivo para cerrar definitivamente la CAPA tras completar acciones y verificación">¿Qué es?</span></label>
            <input id="fechaCierre" type="date" placeholder="dd/mm/aaaa">
          </div>
          <div>
            <label>Semana (S00–S52) <span class="help" title="Se autocalcula desde la Fecha de detección; puedes ajustar manualmente.">ⓘ</span></label>
            <select id="semanaSel"></select>
          </div>
        </div>

        <div class="grid g3">
          <div>
            <label>¿Dónde? (proceso/lugar)</label>
            <select id="donde">
              <option value="Campo">Campo</option>
              <option value="Transporte">Transporte</option>
              <option value="Packing">Packing</option>
              <option value="Naviera">Naviera</option>
              <option value="Documentación">Documentación</option>
              <option value="Cliente">Cliente</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
          <div>
            <label>Proveedor/Cliente (opcional)</label>
            <input id="tercero" placeholder="Nombre del campo, packing, naviera o cliente"/>
          </div>
          <div>
            <label>Gravedad (matriz de riesgo)</label>
            <select id="gravedad">
              <option value="Baja">Baja</option>
              <option value="Media">Media</option>
              <option value="Alta">Alta</option>
              <option value="Crítica">Crítica</option>
            </select>
          </div>
        </div>

        <div class="grid g3">
          <div>
            <label>Probabilidad (manual)</label>
            <select id="probabilidad">
              <option value="1">Muy baja (1)</option>
              <option value="2">Baja (2)</option>
              <option value="3">Media (3)</option>
              <option value="4">Alta (4)</option>
            </select>
          </div>
          <div>
            <label>Nivel de riesgo (S×P)</label>
            <div id="riesgoPill" class="risk r-low">Bajo · 1</div>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="tag">Regla: Baja=1 · Media=2 · Alta=3 · Crítica=4</div>
          </div>
        </div>

        <div class="grid g2">
          <div>
            <label>Quien reporta</label>
            <input id="reporta" placeholder="Nombre del responsable del registro"/>
          </div>
          <div>
            <label>Descripción del problema</label>
            <textarea id="desc" placeholder="Qué ocurrió, dónde, impacto (n° pallets, cajas afectadas, lote, contenedor, etc.)"></textarea>
          </div>
        </div>

        <div class="grid g2">
          <div>
            <h3>Acción de contención <span class="help" title="Medida inmediata para contener/mitigar el impacto ahora (ej.: detener embarque del lote, re-etiquetar, aumentar inspección). NO resuelve la causa raíz.">¿Qué es?</span></h3>
            <label>Descripción</label>
            <textarea id="accionContencion"></textarea>
            <div class="grid g3">
              <div>
                <label>Responsable</label>
                <input id="respContencion"/>
              </div>
              <div>
                <label>Fecha compromiso</label>
                <input id="fechaContencion" type="date"/>
              </div>
              <div>
                <label>Completada</label>
                <select id="doneContencion"><option>No</option><option>Sí</option></select>
              </div>
            </div>
          </div>
          <div>
            <h3>Acción definitiva <span class="help" title="Medida que elimina la CAUSA RAÍZ para que no vuelva a ocurrir (ej.: estandarizar procedimiento, modificar especificación, contrato, proveedor, capacitación).">¿Qué es?</span></h3>
            <label>Descripción</label>
            <textarea id="accionDefinitiva"></textarea>
            <div class="grid g3">
              <div>
                <label>Responsable</label>
                <input id="respDefinitiva"/>
              </div>
              <div>
                <label>Fecha compromiso</label>
                <input id="fechaDefinitiva" type="date"/>
              </div>
              <div>
                <label>Completada</label>
                <select id="doneDefinitiva"><option>No</option><option>Sí</option></select>
              </div>
            </div>
          </div>
        </div>

        <h3>Causa raíz y verificación</h3>
        <div class="grid g3">
          <div>
            <label>Causa raíz (5-Why/Ishikawa)</label>
            <input id="causaRaiz" placeholder="Enunciado concreto y verificable"/>
          </div>
          <div>
            <label>Plan de verificación</label>
            <input id="planVerif" placeholder="Cómo validar eficacia (métrica, muestreo, periodo)"/>
          </div>
          <div>
            <label>Fecha verificación</label>
            <input id="fechaVerif" type="date"/>
          </div>
        </div>

        <h3>Evidencias (PDF/PNG/JPG) <span class="tag">se guardan localmente</span></h3>
        <div class="uploader" id="dropZone">
          <p>Arrastra archivos aquí o <label for="evidInput" class="help" title="Selecciona archivos de tu equipo"><span class="kbd">Selecciona</span></label></p>
          <input id="evidInput" type="file" accept="application/pdf,image/png,image/jpeg" multiple style="display:none"/>
        </div>
        <div class="evidence-list" id="evidList"></div>

        <div class="actions">
          <button id="btnGuardar" class="ok">Guardar</button>
          <button id="btnRevision" class="warn">Guardar como revisión +1</button>
          <button id="btnNuevo" class="ghost">Limpiar formulario</button>
          <span class="pill">ID fijo <span title="El ID no cambia entre revisiones">ⓘ</span> · <span>Revisión <input id="revQuick" type="number" min="0" style="width:64px"></span></span>
        </div>

        <div class="actions" style="margin-top:6px">
          <button id="btnPDF">Exportar PDF</button>
          <button id="btnPDFVer" class="ghost">Ver PDF</button>
          <button id="btnPDFShare" class="ghost">Compartir PDF</button>
          <button id="btnBackup" class="ghost">Exportar respaldo (.json)</button>
          <button id="btnImport" class="ghost">Importar (.json)</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
          <span class="tag">El PDF incluye miniaturas de imágenes y listado de PDFs</span>
        </div>
      </section>

      <!-- Listado -->
      <section class="card" id="listCard">
        <h2>CAPAs registradas</h2>
        <div class="grid g3">
          <div>
            <label>Filtro estado</label>
            <select id="fEstado"><option value="">Todos</option><option>Abierta</option><option>En contención</option><option>En curso</option><option>Cerrada</option></select>
          </div>
          <div>
            <label>Filtro ¿Dónde?</label>
            <select id="fDonde"><option value="">Todos</option><option>Campo</option><option>Transporte</option><option>Packing</option><option>Naviera</option><option>Documentación</option><option>Cliente</option><option>Otro</option></select>
          </div>
          <div>
            <label>Buscar texto</label>
            <input id="fTexto" placeholder="ID, proveedor, problema…"/>
          </div>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="tabla">
            <thead>
              <tr>
                <th>ID</th>
                <th>Rev</th>
                <th>Estado</th>
                <th>Detección</th>
                <th>Semana</th>
                <th>¿Dónde?</th>
                <th>Gravedad</th>
                <th>Prob.</th>
                <th>Riesgo</th>
                <th>Proveedor/Cliente</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>

    <div class="footer">Tip: publica este archivo como <span class="kbd">index.html</span> en GitHub Pages. Funciona 100% local (IndexedDB + localStorage).</div>
  </div>

  <!-- Modal para vista previa de evidencias y PDF -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-inner">
      <div class="modal-head">
        <div id="modalTitle" class="modal-title">Vista previa</div>
        <button class="modal-close" id="modalClose">Cerrar</button>
      </div>
      <div class="modal-content" id="modalContent"></div>
    </div>
  </div>

  <!-- Librerías livianas por CDN -->
  <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // ========= Utilidades =========
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const DB = idbKeyval; // IndexedDB para evidencias (blobs)

    const keySeq = () => `capa:seq:global`;
    const nextId = () => {
      let seq = parseInt(localStorage.getItem(keySeq())||'0',10)+1;
      localStorage.setItem(keySeq(), String(seq));
      return `CAPA-${String(seq).padStart(3,'0')}`;
    }

    const fmt = d => d? new Date(d).toLocaleDateString('es-CL') : '';
    const bytes = n => {
      if(n<1024) return n+" B"; if(n<1024*1024) return (n/1024).toFixed(1)+" KB"; return (n/1024/1024).toFixed(1)+" MB";
    }

    // Semana 0–52 (0-based) desde fecha (ISO week - 1)
    function week0to52(dateStr){
      if(!dateStr) return 0;
      const d = new Date(dateStr);
      const target = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNr = (target.getUTCDay() + 6) % 7; // lunes=0
      target.setUTCDate(target.getUTCDate() - dayNr + 3); // jueves ISO
      const firstThursday = new Date(Date.UTC(target.getUTCFullYear(),0,4));
      const week = 1 + Math.round(((target - firstThursday)/86400000 - 3) / 7);
      return Math.max(0, Math.min(52, week - 1));
    }

    function readCapas(){ return JSON.parse(localStorage.getItem('capas')||'[]'); }
    function writeCapas(arr){ localStorage.setItem('capas', JSON.stringify(arr)); }
    function upsertCapa(obj){
      const arr = readCapas();
      const idx = arr.findIndex(x=>x.id===obj.id);
      if(idx>=0) arr[idx]=obj; else arr.unshift(obj);
      writeCapas(arr);
      renderTable();
    }

    function getCapa(id){ return readCapas().find(x=>x.id===id); }

    // ========= Riesgo =========
    const sevToNum = s => ({'Baja':1,'Media':2,'Alta':3,'Crítica':4}[s]||1);
    function calcRisk(gravedad, prob){
      const s = sevToNum(gravedad); const p = parseInt(prob||1,10);
      const score = s*p;
      let level = 'Bajo', cls = 'r-low';
      if(score>=4 && score<=6){ level='Medio'; cls='r-med'; }
      if(score>=7 && score<=9){ level='Alto'; cls='r-high'; }
      if(score>=10){ level='Crítico'; cls='r-crit'; }
      return {score, level, cls};
    }

    function updateRiskPill(){
      const g = $('#gravedad').value; const p = $('#probabilidad').value;
      const {score, level, cls} = calcRisk(g,p);
      const pill = $('#riesgoPill');
      pill.className = 'risk ' + cls;
      pill.textContent = `${level} · ${score}`;
    }

    // ========= Estado del formulario =========
    let currentEvidenceKeys = []; // claves en IndexedDB

    function fillWeekSelect(){
      const s = $('#semanaSel'); s.innerHTML='';
      for(let i=0;i<=52;i++){
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = `S${String(i).padStart(2,'0')}`;
        s.appendChild(opt);
      }
    }
    function setWeekSelect(n){
      const s = $('#semanaSel');
      if(n==='' || n==null || Number.isNaN(n)) s.value = '0'; else s.value = String(Math.max(0,Math.min(52, n)));
    }
    function getWeekNumber(){ return parseInt($('#semanaSel').value,10); }

    function clearForm(){
      $('#capaId').value = '';
      $('#capaRev').value = 0;
      $('#revQuick').value = 0;
      $('#capaEstado').value = 'Abierta';
      $('#fechaDeteccion').value = '';
      $('#fechaCierre').value = '';
      setWeekSelect(0);
      $('#donde').value = 'Campo';
      $('#tercero').value = '';
      $('#gravedad').value = 'Baja';
      $('#probabilidad').value = '1';
      updateRiskPill();
      $('#reporta').value = '';
      $('#desc').value = '';
      $('#accionContencion').value = '';
      $('#respContencion').value = '';
      $('#fechaContencion').value = '';
      $('#doneContencion').value = 'No';
      $('#accionDefinitiva').value = '';
      $('#respDefinitiva').value = '';
      $('#fechaDefinitiva').value = '';
      $('#doneDefinitiva').value = 'No';
      $('#causaRaiz').value = '';
      $('#planVerif').value = '';
      $('#fechaVerif').value = '';
      currentEvidenceKeys = [];
      renderEvidence();
    }

    function loadForm(obj){
      $('#capaId').value = obj.id;
      $('#capaRev').value = obj.revision||0;
      $('#revQuick').value = obj.revision||0;
      $('#capaEstado').value = obj.estado||'Abierta';
      $('#fechaDeteccion').value = obj.fechaDeteccion||'';
      $('#fechaCierre').value = obj.fechaCierre||'';
      setWeekSelect(typeof obj.semana==='number'? obj.semana : week0to52(obj.fechaDeteccion));
      $('#donde').value = obj.donde||'Campo';
      $('#tercero').value = obj.tercero||'';
      $('#gravedad').value = obj.gravedad||'Baja';
      $('#probabilidad').value = String(obj.probabilidad||1);
      updateRiskPill();
      $('#reporta').value = obj.reporta||'';
      $('#desc').value = obj.desc||'';
      $('#accionContencion').value = obj.accionContencion||'';
      $('#respContencion').value = obj.respContencion||'';
      $('#fechaContencion').value = obj.fechaContencion||'';
      $('#doneContencion').value = obj.doneContencion||'No';
      $('#accionDefinitiva').value = obj.accionDefinitiva||'';
      $('#respDefinitiva').value = obj.respDefinitiva||'';
      $('#fechaDefinitiva').value = obj.fechaDefinitiva||'';
      $('#doneDefinitiva').value = obj.doneDefinitiva||'No';
      $('#causaRaiz').value = obj.causaRaiz||'';
      $('#planVerif').value = obj.planVerif||'';
      $('#fechaVerif').value = obj.fechaVerif||'';
      currentEvidenceKeys = Array.isArray(obj.evidenceKeys)? [...obj.evidenceKeys] : [];
      renderEvidence();
    }

    function collectForm(){
      const id = $('#capaId').value || nextId();
      const g = $('#gravedad').value; const p = $('#probabilidad').value;
      const risk = calcRisk(g,p);
      const obj = {
        id,
        revision: parseInt($('#capaRev').value||'0',10),
        estado: $('#capaEstado').value,
        fechaDeteccion: $('#fechaDeteccion').value,
        fechaCierre: $('#fechaCierre').value,
        semana: getWeekNumber(),
        donde: $('#donde').value,
        tercero: $('#tercero').value.trim(),
        gravedad: g,
        probabilidad: parseInt(p,10),
        riesgoScore: risk.score,
        riesgoNivel: risk.level,
        reporta: $('#reporta').value.trim(),
        desc: $('#desc').value.trim(),
        accionContencion: $('#accionContencion').value.trim(),
        respContencion: $('#respContencion').value.trim(),
        fechaContencion: $('#fechaContencion').value,
        doneContencion: $('#doneContencion').value,
        accionDefinitiva: $('#accionDefinitiva').value.trim(),
        respDefinitiva: $('#respDefinitiva').value.trim(),
        fechaDefinitiva: $('#fechaDefinitiva').value,
        doneDefinitiva: $('#doneDefinitiva').value,
        causaRaiz: $('#causaRaiz').value.trim(),
        planVerif: $('#planVerif').value.trim(),
        fechaVerif: $('#fechaVerif').value,
        evidenceKeys: [...currentEvidenceKeys],
        updatedAt: new Date().toISOString()
      };
      return obj;
    }

    // Eventos de riesgo
    $('#gravedad').addEventListener('change', updateRiskPill);
    $('#probabilidad').addEventListener('change', updateRiskPill);

    // Autocalcular semana al cambiar fecha
    $('#fechaDeteccion').addEventListener('change', ()=>{
      const w = week0to52($('#fechaDeteccion').value);
      setWeekSelect(w);
    });

    // ========= Evidencias =========
    const drop = $('#dropZone');
    const input = $('#evidInput');

    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.background = '#0b1119';})
    drop.addEventListener('dragleave', ()=>{ drop.style.background = '#0e141d';})
    drop.addEventListener('drop', async (e)=>{
      e.preventDefault(); drop.style.background = '#0e141d';
      await addFiles(e.dataTransfer.files);
    })
    input.addEventListener('change', async e=>{
      await addFiles(e.target.files);
      input.value = '';
    });

    async function addFiles(fileList){
      for(const file of fileList){
        if(!['application/pdf','image/png','image/jpeg'].includes(file.type)) continue;
        let blob = file;
        if(file.type.startsWith('image/')){
          blob = await compressImage(file, 1600, 85);
          try{ blob.name = file.name; }catch(_){/* opcional */}
        }
        const key = `ev:${crypto.randomUUID()}`;
        await DB.set(key, blob);
        currentEvidenceKeys.push(key);
      }
      renderEvidence();
    }

    async function compressImage(file, maxW=1600, quality=85){
      const img = new Image();
      const url = URL.createObjectURL(file);
      await new Promise(res=>{ img.onload=()=>res(); img.src=url; });
      const scale = Math.min(1, maxW / img.width);
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(img.width * scale);
      canvas.height = Math.round(img.height * scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      return await new Promise(res=> canvas.toBlob(res, 'image/jpeg', quality/100));
    }

    async function renderEvidence(){
      const cont = $('#evidList');
      cont.innerHTML = '';
      for(const key of currentEvidenceKeys){
        const blob = await DB.get(key);
        if(!blob) continue;
        const div = document.createElement('div');
        div.className = 'ev';
        const isImg = blob.type.startsWith('image/');
        if(isImg){
          const img = document.createElement('img');
          img.className = 'thumb'; img.alt='';
          img.src = URL.createObjectURL(blob);
          img.onclick = ()=> previewBlob(blob, 'Imagen');
          div.appendChild(img);
        } else {
          const ph = document.createElement('div');
          ph.className='thumb';
          ph.style.display='grid'; ph.style.placeItems='center';
          ph.innerHTML = '<div class="tag">PDF</div>';
          ph.onclick = ()=> previewBlob(blob, 'Documento PDF');
          div.appendChild(ph);
        }
        const meta = document.createElement('div');
        meta.className = 'meta';
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = blob.name || (isImg? 'Imagen' : 'Documento PDF');
        const size = document.createElement('div'); size.className='size'; size.textContent = `${blob.type.replace('image/','')||'pdf'} · ${bytes(blob.size||0)}`;
        const row = document.createElement('div'); row.className='actions';
        const pv = document.createElement('button'); pv.className='ghost'; pv.textContent='Vista previa';
        pv.onclick = ()=> previewBlob(blob, name.textContent);
        const dl = document.createElement('button'); dl.className='ghost'; dl.textContent='Descargar';
        dl.onclick = ()=> downloadBlob(blob, (blob.name||'evidencia'));
        const rm = document.createElement('button'); rm.className='danger'; rm.textContent='Eliminar';
        rm.onclick = async ()=>{ await DB.del(key); currentEvidenceKeys = currentEvidenceKeys.filter(k=>k!==key); renderEvidence(); };
        row.append(pv, dl, rm);
        meta.append(name,size,row);
        div.appendChild(meta);
        cont.appendChild(div);
      }
    }

    function previewBlob(blob, title='Vista previa'){
      const modal = $('#modal');
      const content = $('#modalContent');
      $('#modalTitle').textContent = title;
      content.innerHTML = '';
      const url = URL.createObjectURL(blob);
      if(blob.type.startsWith('image/')){
        const img = document.createElement('img'); img.src = url; content.appendChild(img);
      } else if(blob.type==='application/pdf'){
        const iframe = document.createElement('iframe');
        iframe.src = url; content.appendChild(iframe);
      } else {
        const a = document.createElement('a'); a.href=url; a.textContent='Abrir'; a.target='_blank'; content.appendChild(a);
      }
      modal.classList.add('open');
    }

    $('#modalClose').addEventListener('click', ()=> $('#modal').classList.remove('open'));
    $('#modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') $('#modal').classList.remove('open'); });

    function downloadBlob(blob, name){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = name; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    }

    // ========= Tabla =========
    function riskClassFromLevel(level){
      return level==='Crítico'?'r-crit':level==='Alto'?'r-high':level==='Medio'?'r-med':'r-low';
    }

    function renderTable(){
      const tbody = $('#tabla tbody');
      const arr = readCapas();
      const fE = $('#fEstado').value; const fD = $('#fDonde').value; const fT = ($('#fTexto').value||'').toLowerCase();
      tbody.innerHTML='';
      for(const x of arr.filter(x=> (fE?x.estado===fE:true) && (fD?x.donde===fD:true) && JSON.stringify(x).toLowerCase().includes(fT))){
        const tr = document.createElement('tr');
        const level = x.riesgoNivel || calcRisk(x.gravedad, x.probabilidad||1).level;
        const score = x.riesgoScore || calcRisk(x.gravedad, x.probabilidad||1).score;
        tr.innerHTML = `
          <td><span class="kbd">${x.id}</span></td>
          <td>${x.revision??0}</td>
          <td><span class="state ${x.estado==='Abierta'?'s-open':x.estado==='En contención'?'s-hold':x.estado==='En curso'?'s-run':'s-done'}">${x.estado}</span></td>
          <td>${fmt(x.fechaDeteccion)}</td>
          <td>${x.semana!=null ? `S${String(x.semana).padStart(2,'0')}` : ''}</td>
          <td>${x.donde||''}</td>
          <td>${x.gravedad||'Baja'}</td>
          <td>${x.probabilidad||1}</td>
          <td><span class="risk ${riskClassFromLevel(level)}">${level} · ${score}</span></td>
          <td>${x.tercero||''}</td>
          <td>
            <button class="ghost" data-act="editar" data-id="${x.id}">Editar</button>
            <button class="ghost" data-act="pdf" data-id="${x.id}">PDF</button>
            <button class="danger" data-act="borrar" data-id="${x.id}">Borrar</button>
          </td>`;
        tbody.appendChild(tr);
      }
    }

    $('#tabla').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.getAttribute('data-id'); const act = btn.getAttribute('data-act');
      const obj = getCapa(id);
      if(!obj) return;
      if(act==='editar') loadForm(obj);
      if(act==='pdf') exportPDF(obj, {save:true});
      if(act==='borrar'){
        if(confirm('¿Eliminar CAPA '+id+'?')){
          const rest = readCapas().filter(x=>x.id!==id); writeCapas(rest); renderTable();
        }
      }
    });

    // ========= Guardado =========
    $('#btnGuardar').addEventListener('click', ()=>{
      const obj = collectForm();
      upsertCapa(obj);
      $('#capaId').value = obj.id; // asegurar fijo
      alert('Guardado ✔');
    });

    $('#btnRevision').addEventListener('click', ()=>{
      const obj = collectForm();
      obj.revision = (parseInt(obj.revision||0,10) + 1);
      $('#capaRev').value = obj.revision; $('#revQuick').value = obj.revision;
      upsertCapa(obj);
      alert('Guardado como nueva revisión ✔');
    });

    $('#revQuick').addEventListener('input', ()=>{ $('#capaRev').value = $('#revQuick').value; });
    $('#btnNuevo').addEventListener('click', ()=> clearForm());

    // ========= Filtros =========
    $('#fEstado').addEventListener('change', renderTable);
    $('#fDonde').addEventListener('change', renderTable);
    $('#fTexto').addEventListener('input', renderTable);

    // ========= Backup/Import =========
    $('#btnBackup').addEventListener('click', ()=>{
      const data = readCapas();
      const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      downloadBlob(blob, 'capas_backup.json');
    });
    $('#btnImport').addEventListener('click', ()=> $('#importFile').click());
    $('#importFile').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const txt = await f.text();
      try{
        const arr = JSON.parse(txt); writeCapas(arr); renderTable(); alert('Importado ✔');
      }catch(err){ alert('Archivo inválido'); }
    });

    // ========= PDF =========
    $('#btnPDF').addEventListener('click', async ()=>{
      const obj = collectForm();
      await exportPDF(obj, {save:true});
    });
    $('#btnPDFVer').addEventListener('click', async ()=>{
      const obj = collectForm();
      const {blob, name} = await exportPDF(obj, {returnBlob:true});
      previewBlob(blob, name);
    });
    $('#btnPDFShare').addEventListener('click', async ()=>{
      const obj = collectForm();
      const {blob, name} = await exportPDF(obj, {returnBlob:true});
      const file = new File([blob], name, {type:'application/pdf'});
      if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
        try{ await navigator.share({files:[file], title:name, text:'CAPA generado desde ACONFEX CAPA'}); }catch(e){}
      }else{
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        setTimeout(()=>URL.revokeObjectURL(url), 10000);
        alert('Compartir no soportado por el navegador. Se abrió el PDF en una pestaña.');
      }
    });

    async function exportPDF(obj, opts={save:false, returnBlob:false}){
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({unit:'pt', format:'a4'});

      if(obj && obj.id){ currentEvidenceKeys = obj.evidenceKeys || []; }

      const margin = 36; let y = margin;
      pdf.setFillColor(15,22,32); pdf.rect(0,0,595,60,'F');
      pdf.setTextColor(255,255,255); pdf.setFontSize(14); pdf.text('ACONFEX · CAPA', margin, 38);
      pdf.setTextColor(0,0,0); pdf.setFontSize(12);

      function row(label, value){ pdf.setFont(undefined,'bold'); pdf.text(label, margin, y); pdf.setFont(undefined,'normal'); pdf.text(String(value||''), 200, y); y+=18; }

      y += 40;
      row('ID', obj.id);
      row('Revisión', obj.revision);
      row('Estado', obj.estado);
      row('Fecha detección', fmt(obj.fechaDeteccion));
      row('Fecha cierre comprometida', fmt(obj.fechaCierre));
      row('Semana', (obj.semana!=null? `S${String(obj.semana).padStart(2,'0')}` : ''));
      row('¿Dónde?', obj.donde);
      row('Gravedad', obj.gravedad);
      row('Probabilidad', obj.probabilidad);
      row('Riesgo (S×P)', `${obj.riesgoNivel} · ${obj.riesgoScore}`);
      row('Proveedor/Cliente', obj.tercero);
      row('Quien reporta', obj.reporta);

      y+=10; pdf.setFont(undefined,'bold'); pdf.text('Descripción del problema', margin, y); y+=12; pdf.setFont(undefined,'normal');
      y = writeMultiline(pdf, obj.desc||'', margin, y, 520);

      if(y>700){ pdf.addPage(); y = margin; }
      pdf.setFont(undefined,'bold'); pdf.text('Acción de contención (mitiga ahora)', margin, y); y+=12; pdf.setFont(undefined,'normal');
      y = writeMultiline(pdf, obj.accionContencion||'', margin, y, 520);
      y+=6; row('Resp. contención', obj.respContencion); row('Fecha compromiso', fmt(obj.fechaContencion)); row('Completada', obj.doneContencion);

      if(y>700){ pdf.addPage(); y = margin; }
      pdf.setFont(undefined,'bold'); pdf.text('Acción definitiva (corrige causa raíz)', margin, y); y+=12; pdf.setFont(undefined,'normal');
      y = writeMultiline(pdf, obj.accionDefinitiva||'', margin, y, 520);
      y+=6; row('Resp. definitiva', obj.respDefinitiva); row('Fecha compromiso', fmt(obj.fechaDefinitiva)); row('Completada', obj.doneDefinitiva);

      if(y>700){ pdf.addPage(); y = margin; }
      pdf.setFont(undefined,'bold'); pdf.text('Causa raíz y verificación', margin, y); y+=12; pdf.setFont(undefined,'normal');
      y = writeMultiline(pdf, `Causa raíz: ${obj.causaRaiz||''}\nPlan de verificación: ${obj.planVerif||''}\nFecha verificación: ${fmt(obj.fechaVerif)}`, margin, y, 520);

      // Evidencias
      const imgs = []; const pdfs = [];
      const keySet = new Set([...(obj.evidenceKeys||[]), ...currentEvidenceKeys]);
      for(const key of keySet){
        const blob = await DB.get(key); if(!blob) continue;
        if(blob.type.startsWith('image/')) imgs.push(blob); else if(blob.type==='application/pdf') pdfs.push(blob);
      }

      if(imgs.length || pdfs.length){
        if(y>620){ pdf.addPage(); y = margin; }
        pdf.setFont(undefined,'bold'); pdf.text('Evidencias', margin, y); y+=12; pdf.setFont(undefined,'normal');
      }

      // grid 2xN de imágenes
      const boxW = 250, boxH = 150, gap = 14; let col = 0; let x = margin;
      for(const imgBlob of imgs){
        const dataUrl = await blobToDataURL(imgBlob);
        const img = await loadImage(dataUrl);
        const ratio = Math.min(boxW/img.width, boxH/img.height);
        const w = img.width*ratio, h = img.height*ratio;
        const fmtI = dataUrl.startsWith('data:image/png') ? 'PNG' : 'JPEG';
        pdf.addImage(dataUrl, fmtI, x + (boxW-w)/2, y + (boxH-h)/2, w, h);
        pdf.setDrawColor(220); pdf.rect(x, y, boxW, boxH);
        col++;
        if(col===2){ col=0; x=margin; y += boxH + gap; if(y>740){ pdf.addPage(); y = margin; } }
        else { x = margin + boxW + gap; }
      }
      if(col!==0){ y += boxH + gap; }

      if(pdfs.length){
        if(y>740){ pdf.addPage(); y = margin; }
        pdf.setFont(undefined,'bold'); pdf.text('Documentos PDF (no embebidos):', margin, y); y+=16; pdf.setFont(undefined,'normal');
        pdf.setFontSize(11);
        for(const b of pdfs){
          pdf.text('• '+(b.name||'Documento PDF')+` — ${bytes(b.size||0)}`, margin, y);
          y+=14; if(y>780){ pdf.addPage(); y = margin; }
        }
        pdf.setFontSize(12);
      }

      const name = `${obj.id}-CAPA.pdf`;

      if(opts.returnBlob){
        const blob = pdf.output('blob');
        return {blob, name};
      }
      if(opts.save){ pdf.save(name); }
    }

    function writeMultiline(pdf, text, x, y, maxWidth){
      const lines = pdf.splitTextToSize(String(text||''), maxWidth);
      for(const ln of lines){ pdf.text(ln, x, y); y+=16; }
      return y;
    }
    function blobToDataURL(blob){
      return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); });
    }
    function loadImage(src){ return new Promise(res=>{ const i=new Image(); i.onload=()=>res(i); i.src=src; }); }

    // ========= Init =========
    fillWeekSelect();
    clearForm();
    renderTable();
  </script>
</body>
</html>
